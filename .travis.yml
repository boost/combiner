language: node_js

stages:
  - name: test
  - name: deploy
    if: (branch = master) AND (type != pull_request)

jobs:
  include:
    # LINT
    - stage: test
      name: JS Lint
      script:
        - npm run lint
    - stage: test
      name: Firefox Lint
      script:
        - npm run build:firefox
        - npm run web-ext:lint
    - stage: test
      name: Chrome Lint
      script:
        - npm run build:chrome
        - npm run web-ext:lint

    # DEPLOY
    - stage: deploy
      name: Deploy Chrome
      script:
        - npm run build:chrome
        - ./node_modules/.bin/webstore upload \
            --source=./build \
            --extension-id=$CHROME_ID \
            --client-id=$CHROME_CLIENT_ID \
            --client-secret=$CHROME_CLIENT_SECRET \
            --refresh-token=CHROME_REFRESH_TOKEN \
            --auto-publish
    - stage: deploy
      name: Deploy Firefox
      script:
        - npm run build:firefox
        - npm run web-ext:lint
        - ./node_modules/.bin/web-ext sign \
            --source-dir=./build
            --id=$FIREFOX_ID
            --api-key=$FIREFOX_JWT_ISSUER \
            --api-secret=$FIREFOX_JWT_SECRET \
